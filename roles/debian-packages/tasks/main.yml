---

- name: dpkg remove i386
  become: yes
  command: dpkg --remove-architecture i386

- name: update apt-cache
  become: yes
  apt:
    update_cache: yes

- name: install common developer tools
  become: yes
  apt:
    pkg: "{{ item }}"
    state: latest
  with_items:
    - cscope
    - ctags
    - debconf-utils
    - docker
    - genisoimage
    - git
    - htop
    - iftop
    - iotop
    - syslinux-utils # for isohybrid
    - libguestfs-tools
    - libvirt-bin
    - mdadm
    - mongodb
    - python-pip
    - python3-pip
    - python3-libvirt
    - python3-paramiko
    - python3-yaml
    - qemu-system-x86
    - smartmontools
    - squashfs-tools
    - ssh
    - tree
    - twine # for uploading python packages to pypi
    - virt-manager

- name: install python3 packages that are only available via pip
  become: yes
  pip:
    name: "{{ item }}"
    state: latest
    executable: pip3
  with_items:
    - pymongo

# This task will take effect after a reboot.
 - name: add current user to group libvirtd
  become: yes
  user:
    name: "{{ ansible_user_id }}"
    groups: docker
    append: yes

# The libvirt has a feature called dynamic_ownership that causes libvirtd to
# change the ownership of disk images to root:root every time the containing
# libvirt domain is started.  That conflicts with the use model where non-root
# users can freely use libvirt domains.  As a result, turn dynamic_ownership off
# here.
- name: disable dynamic_ownership for libvirt
  become: yes
  lineinfile:
    dest: /etc/libvirt/qemu.conf
    regexp: "^dynamic_ownership(?! = 0)"
    line: "dynamic_ownership = 0"
    state: present
    backrefs: yes # if no match, do not change the file
  notify: restart-libvirt

- name: add gpg key for third party apt-repos
  become: yes
  apt_key:
    url: "{{ item }}"
    state: present
  with_items:
#    - http://dev.iachieved.it/iachievedit.gpg.key
    - https://bazel.build/bazel-release.pub.gpg

- name: add third party apt-repos
  become: yes
  apt_repository:
    repo: "{{ item }}"
    state: present
  with_items:
    #- "deb http://iachievedit-repos.s3.amazonaws.com/ {{ ansible_distribution_release }} main"
    - deb http://storage.googleapis.com/bazel-apt stable jdk1.8
    - ppa:ansible/ansible

- name: apt-get update
  become: yes
  apt:
    update_cache: yes

- name: install various packages that are only available from third party apt repos
  become: yes
  apt:
    pkg: "{{ item }}"
    state: latest
  with_items:
    - ansible
    - bazel
    #- swift-3.0


#- name: add swift path to bashrc
  #lineinfile:
    #dest: "{{ lookup('env','HOME') }}/.bashrc_main"
    #state: present
    #line: "export PATH=/opt/swift/swift-3.0/usr/bin:$PATH"

- name: flush_handlers
  meta: flush_handlers
